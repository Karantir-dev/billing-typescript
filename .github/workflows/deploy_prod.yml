name: Deployment - Prod
on:
  push:
    branches:
      - 'main'
      
env:
  IMAGE_NAME: ${{secrets.DOCKER_USERNAME}}/zomro-bill-prod
  PREFIX: _${{ github.run_number }}

jobs:
  jest:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install -f
      - run: npm run test
      - name: test status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        if: always()
  eslint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install -g npm
      - run: npm install
      - run: npm run lint
      - name: linter status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        if: always()

  build_and_push:
    needs: [jest, eslint]
    name: Build and push bill docker
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
      DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v1

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      
      - name: Test with environment variables
        run: |
          echo $TAG_NAME - $RELEASE_NAME
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}${{ env.PREFIX }}
          
      - name: Login to docker hub
        run: 
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          
      - name: Build image 
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}${{ env.PREFIX }}
        run: |
          docker build -f Dockerfile.prod -t $IMAGE_NAME .
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:latest
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:$RELEASE_NAME
      
      - name: Push in dockerhub 
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}${{ env.PREFIX }}
        run: |
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$RELEASE_NAME
          
      - name: Push status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()


  deploy_on_server:
    needs: [build_and_push]
    name: Deploy version on server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v1
        
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      
      - name: Test with environment variables
        run: |
          echo $TAG_NAME - $RELEASE_NAME
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}${{ env.PREFIX }}
        
      - name: Update Version
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}${{ env.PREFIX }}
        run: |
          sed -i "s|$IMAGE_NAME|$IMAGE_NAME:$RELEASE_NAME|" $GITHUB_WORKSPACE/deployment/deployment_prod.yml
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save DigitalOcean kubeconfig with short-lived credentials
        run:
          doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ secrets.K8S_CL_NAME }}

      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f $GITHUB_WORKSPACE/deployment/deployment_prod.yml

      - name: Verify deployment
        run: kubectl rollout status deployment/zomro-bill-prod-deployment -n prod
      
      - name: Deploy status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
