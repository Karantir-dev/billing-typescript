name: Ansible Deployment
on:
  push:
    branches:
      - 'main'
jobs:
  jest:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install -f
      - run: npm run test
      - name: test status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        if: always()
  eslint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install -g npm
      - run: npm install
      - run: npm run lint
      - name: linter status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
        if: always()

  deploy:
    needs: [jest]
    name: Deploy image to server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v1

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d-%H')"
      
      - name: Test with environment variables
        run: echo $TAG_NAME - $RELEASE_NAME
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}

      - name: Login to docker hub
        env:
          DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
          DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
          RELEASE_NAME: release-${{ steps.date.outputs.date }}
        run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          docker build -f Dockerfile.prod -t zomro-bill-prod .
          docker tag zomro-bill-prod:latest zomrocom/zomro-bill-prod:latest
          docker tag zomrocom/zomro-bill-prod:latest zomrocom/zomro-bill-prod:$RELEASE_NAME
          docker push $DOCKER_USERNAME/zomro-bill-prod:latest
          docker push $DOCKER_USERNAME/zomro-bill-prod:$RELEASE_NAME
      - name: Update Version
        env:
          RELEASE_NAME: release-${{ steps.date.outputs.date }}
        run: |
          sed -i "s|zomrocom/zomro-bill-prod|zomrocom/zomro-bill-prod:$RELEASE_NAME|" $GITHUB_WORKSPACE/deployment/deployment_prod.yml
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save DigitalOcean kubeconfig with short-lived credentials
        run:
          doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ secrets.K8S_CL_NAME }}

      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f $GITHUB_WORKSPACE/deployment/deployment_prod.yml

      - name: Verify deployment
        run: kubectl rollout status deployment/zomro-bill-prod-deployment -n prod
      
      - name: Deploy status
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: all
          mention: 'channel'
          channel: 'github-actions'
          if_mention: always
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
